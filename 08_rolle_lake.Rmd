---
title: "08 - Zugang zum See"
author: "Curdin Derungs"
date: "July 2018"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}

#loading libraries
library(sp)
library(raster)
library(rgdal)
library(rgeos)
library(leaflet)
library(ggplot2)
library(RColorBrewer)

#empty workspace
rm(list=ls())
```

In diesem Skript wird für jedes Gebäude in Rolle die Distanz und der Höhenunterschied zum See berechnet.  

Als Rechungsgrundlage dienen ein Digitales Höhenmodell, DHM25 von Swisstopo ([Link](https://www.swisstopo.admin.ch/de/home/products/height/dhm25.html)), und ein aufbereiteter Raster Datensatz, welcher die kontinuierliche Distanz zum Lac du Leman als Rasterwerte enthält.

#Daten einlesen
Die Daten aus dem vorhergehenden Arbeitsschritt werden eingelesen. Hinzu kommen die beiden Layer der Arealstatistik.
```{r reader av, message=FALSE, warning=FALSE}
load("output/06_output/geom/06_rolle_bld_out.Rdata")
rolleCRS<-proj4string(rolle_bld_out)

#pfad für daten auf T laufwerk
dataPath<-"/Volumes/data$/ta/60 FuE/6096 SCCER/609635 FEEBD-II/60963505 Work Packages/JA RED/06-Daten/"

#dhm einlesen
rolle_dhm<-raster(paste(dataPath,"17_see/dhm_rolle_asc.asc",sep=""))
proj4string(rolle_dhm)<-CRS("+init=epsg:21781")
#spplot(rolle_dhm)

#distanz zum see einlesen
rolle_lakeDist<-raster(paste(dataPath,"17_see/distancelake_asc.asc",sep=""))
proj4string(rolle_lakeDist)<-CRS("+init=epsg:2056")
#spplot(rolle_lakeDist)
```

#Distanz und Höhe über Meer pro Gebäude bestimmen
```{r intersect}
#transform bld to centroid-pts for later intersection
rolle_bld_pts <- gCentroid(rolle_bld_out,byid=TRUE)

#get values from dhm for each bld
dhm_bld<-extract(rolle_dhm,rolle_bld_pts)

#subtract the height of the lac du lem.
heightAbSea_bld<-dhm_bld-372

#get distance to lake values for each bld
distL_bld<-extract(rolle_lakeDist,rolle_bld_pts)

rolle_bld_out$elevation<-dhm_bld
rolle_bld_out$aboveLake<-heightAbSea_bld
rolle_bld_out$distanceLake<-distL_bld
```


#Plot Building Characteristics
```{r viz, fig.height=5, fig.width=10}
#maxDist<-max(rolle_bld_out$distanceLake)
#classify distances into 100m cuts
lake_dist_cut<-cut(rolle_bld_out$distanceLake,breaks=seq(0,3000,by = 100),labels=paste(seq(0,2900,by = 100),seq(100,3000,by = 100),sep="-"))

dat<-data.frame(dist=lake_dist_cut,enerBed=rolle_bld_out$enerBed_awel,siaType=rolle_bld_out$sia)

colourCount <- length(levels(dat$siaType)) # number of levels
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

p<-ggplot(dat, aes(x=dist,y=enerBed,fill=factor(siaType)))+
  geom_col()+
  theme_minimal()+
  ggtitle(paste("Energiebedarf (AWEL) in Abhaengigkeit der See-Distanz",sep=""))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1,size=14))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set1"))(colourCount))+
  xlab("Distance (m)")+
  ylab("Energiebedarf (kWh/a)")
p
```

##Save all Information
```{r save}
#abbildung speichern
ggsave(p,filename = "output/08_output/viz/lakeDistance.png",dpi = 500,width = 15,height = 8)

#buildings speichern
save(rolle_bld_out,file="output/08_output/geom/08_rolle_bld_out.Rdata")
```